---
import { getCollection } from "astro:content";

import { ExternalLinkIcon } from "lucide-react";

import FormattedDate from "@/components/FormattedDate.astro";
import Website from "@/components/structured-data/WebSite.astro";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { cn } from "@/lib/utils";

const posts = (
  await getCollection("blog", ({ data }) =>
    !data.external && import.meta.env.PROD ? !data.draft : true,
  )
).sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const years = [
  ...new Set(posts.map((post) => post.data.pubDate.getFullYear())),
];
---

<BaseLayout title="Blog">
  <Website slot="head" />
  <div class="prose py-6">
    <h1>Blog</h1>
    <section class="mt-6 space-y-10">
      {
        years.map((year) => (
          <ul class="ml-0 list-none space-y-6">
            <h2 class="mb-0 pb-2">{year}</h2>
            {posts
              .filter((post) => post.data.pubDate.getFullYear() === year)
              .map((post) => (
                <a
                  href={
                    post.data.external
                      ? post.data.canonicalURL
                      : `/posts/${post.id}/`
                  }
                >
                  <li class="block gap-2 no-underline md:flex md:flex-row">
                    <span
                      class={cn(
                        "text-base hover:opacity-100 hover:transition",
                        post.data.draft ? "opacity-30" : "opacity-80",
                        post.data.external &&
                          "inline-flex flex-wrap items-center gap-1",
                      )}
                    >
                      {post.data.title}
                      {post.data.external && (
                        <ExternalLinkIcon
                          className="inline flex-shrink-0"
                          size={16}
                        />
                      )}
                    </span>
                    <div class="min-w-fit">
                      <FormattedDate
                        date={post.data.pubDate}
                        class="text-muted-foreground text-sm opacity-50 md:inline"
                      />
                    </div>
                  </li>
                </a>
              ))}
          </ul>
        ))
      }
    </section>
  </div>
</BaseLayout>

<style>
  @reference "@/styles/global.css";

  a {
    @apply font-normal! no-underline!;
  }

  .title {
    @apply mt-0! no-underline!;
  }

  .description {
    @apply text-muted-foreground! mt-2! line-clamp-4! text-base!;
  }
</style>
